name: Link PR to Issue

on:
  pull_request:
    types: [opened, edited]

jobs:
  link-issue:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Extract and link issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Find issue references like "close #123" or "fixes #456"
            const issuePattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi;
            const matches = [...body.matchAll(issuePattern)];

            for (const match of matches) {
              const issueNumber = parseInt(match[1]);

              // Add PR milestone to linked issue
              if (pr.milestone) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  milestone: pr.milestone.number
                });
                console.log(`Linked issue #${issueNumber} to milestone ${pr.milestone.title}`);
              }
            }
