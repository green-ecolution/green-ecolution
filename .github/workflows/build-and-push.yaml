name: "Build and Push Images"

on:
  # Build stage images when release PR is created/updated
  pull_request:
    types: [opened, synchronize, labeled]
    branches:
      - main

  # Build prod images when tag is pushed
  push:
    tags:
      - "v*"

  # Manual trigger for any environment
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - stage
          - prod
          - demo

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: green-ecolution/green-ecolution

jobs:
  check-release-pr:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
    steps:
      - name: Check if should build
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'autorelease: pending') }}" == "true" ]]; then
              echo "should-build=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Release PR detected, will build"
            else
              echo "should-build=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è Not a release PR, skipping build"
            fi
          else
            # Tag push or workflow_dispatch - always build
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag or manual trigger, will build"
          fi

  determine-environment:
    runs-on: ubuntu-latest
    needs: check-release-pr
    if: needs.check-release-pr.outputs.should-build == 'true'
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      tag-suffix: ${{ steps.set-env.outputs.tag-suffix }}
      is-release: ${{ steps.set-env.outputs.is-release }}
      image-tag: ${{ steps.set-env.outputs.image-tag }}
    steps:
      - name: Determine environment and tag suffix
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
            if [[ "$ENV" == "prod" ]]; then
              TAG_SUFFIX=""
              IS_RELEASE="true"
            else
              TAG_SUFFIX="-${ENV}"
              IS_RELEASE="false"
            fi
            IMAGE_TAG="${{ github.ref_name }}-$(echo ${{ github.sha }} | cut -c1-7)${TAG_SUFFIX}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            ENV="prod"
            TAG_SUFFIX=""
            IS_RELEASE="true"
            IMAGE_TAG="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            ENV="stage"
            TAG_SUFFIX="-stage"
            IS_RELEASE="false"

            # Extract version from PR title
            PR_TITLE="${{ github.event.pull_request.title }}"
            VERSION=$(echo "$PR_TITLE" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)

            if [[ -n "$VERSION" ]]; then
              SHORT_SHA=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
              IMAGE_TAG="${VERSION}-${SHORT_SHA}-stage"
            else
              IMAGE_TAG="pr-${{ github.event.pull_request.number }}-$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-7)-stage"
            fi
          else
            ENV="stage"
            TAG_SUFFIX="-stage"
            IS_RELEASE="false"
            IMAGE_TAG="${{ github.ref_name }}-$(echo ${{ github.sha }} | cut -c1-7)${TAG_SUFFIX}"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "tag-suffix=$TAG_SUFFIX" >> $GITHUB_OUTPUT
          echo "is-release=$IS_RELEASE" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Environment: $ENV, Tag Suffix: $TAG_SUFFIX, Is Release: $IS_RELEASE, Image Tag: $IMAGE_TAG"

  build-migrations:
    runs-on: ubuntu-latest
    needs: [check-release-pr, determine-environment]
    if: needs.check-release-pr.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push postgres migrations
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./.docker/migrations/Dockerfile.postgres
          platforms: linux/amd64
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/migrations-postgres:${{ needs.determine-environment.outputs.image-tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-backend:
    runs-on: ubuntu-latest
    needs: [check-release-pr, determine-environment]
    if: needs.check-release-pr.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ needs.determine-environment.outputs.image-tag }}
          build-args: |
            ENV=${{ needs.determine-environment.outputs.environment }}
            APP_VERSION=${{ needs.determine-environment.outputs.image-tag }}
            APP_GIT_COMMIT=${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
            APP_GIT_BRANCH=${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref_name }}
            APP_GIT_REPOSITORY=${{ github.repository }}
            APP_BUILD_TIME=${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    runs-on: ubuntu-latest
    needs: [check-release-pr, determine-environment]
    if: needs.check-release-pr.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ needs.determine-environment.outputs.image-tag }}
          build-args: |
            ENV=${{ needs.determine-environment.outputs.environment == 'stage' && 'dev' || 'prod' }}
            BASEURL=/api
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-kustomize:
    runs-on: ubuntu-latest
    needs:
      [
        check-release-pr,
        determine-environment,
        build-migrations,
        build-backend,
        build-frontend,
      ]
    if: needs.check-release-pr.outputs.should-build == 'true'
    outputs:
      target-branch: ${{ steps.target.outputs.branch }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Get Green Ecolution App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: main
          fetch-depth: 0

      - name: Setup kustomize
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          setup-tools: |
            kustomize
          kustomize: "5.4.3"

      - name: Get Green Ecolution App User ID
        id: get-user-id
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

      - name: Initialize git config
        run: |
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Determine target branch
        id: target
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Stage: push directly to the release PR branch
            echo "branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            echo "env=stage" >> $GITHUB_OUTPUT
          else
            # Prod: push to main
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "env=prod" >> $GITHUB_OUTPUT
          fi

      - name: Create or checkout target branch
        run: |
          TARGET_BRANCH="${{ steps.target.outputs.branch }}"

          if git ls-remote --heads origin ${TARGET_BRANCH} | grep -q ${TARGET_BRANCH}; then
            git checkout ${TARGET_BRANCH}
            git pull origin ${TARGET_BRANCH}
          else
            git checkout -b ${TARGET_BRANCH}
          fi

      - name: Update kustomize images
        run: |
          ENV="${{ steps.target.outputs.env }}"
          TAG="${{ needs.determine-environment.outputs.image-tag }}"
          IS_RELEASE="${{ needs.determine-environment.outputs.is-release }}"

          cd ./deploy/kustomize/${ENV}
          kustomize edit set image backend-image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${TAG}
          kustomize edit set image frontend-image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${TAG}
          kustomize edit set image init-migrations-image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/migrations-postgres:${TAG}

          # Also update demo environment on release
          if [[ "$IS_RELEASE" == "true" ]]; then
            cd ../demo
            kustomize edit set image backend-image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${TAG}
            kustomize edit set image frontend-image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${TAG}
            kustomize edit set image init-migrations-image=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/migrations-postgres:${TAG}
          fi

      - name: Commit and push changes
        run: |
          ENV="${{ steps.target.outputs.env }}"
          TAG="${{ needs.determine-environment.outputs.image-tag }}"
          TARGET_BRANCH="${{ steps.target.outputs.branch }}"
          IS_RELEASE="${{ needs.determine-environment.outputs.is-release }}"

          git add deploy/kustomize/${ENV}/kustomization.yaml
          if [[ "$IS_RELEASE" == "true" ]]; then
            git add deploy/kustomize/demo/kustomization.yaml
          fi

          if git commit -m "chore: update ${ENV} image tags to ${TAG} [skip ci]"; then
            git push origin ${TARGET_BRANCH}
            echo "‚úÖ Kustomize ${ENV} updated on branch ${TARGET_BRANCH}"
            if [[ "$IS_RELEASE" == "true" ]]; then
              echo "‚úÖ Kustomize demo also updated"
            fi
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: Update deployment comment on PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          TAG="${{ needs.determine-environment.outputs.image-tag }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          MARKER="<!-- stage-deployment-comment -->"

          # Find and delete existing deployment comments
          COMMENT_IDS=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq ".[] | select(.body | contains(\"${MARKER}\")) | .id")

          for COMMENT_ID in $COMMENT_IDS; do
            echo "Deleting old deployment comment: ${COMMENT_ID}"
            gh api -X DELETE "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}"
          done

          # Create new comment at the bottom
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          gh pr comment ${PR_NUMBER} --body "${MARKER}
          ## üöÄ Stage Deployment Ready

          Docker images have been built and the kustomize config has been updated in this PR branch.
          Preview the changes at https://app.stage.green-ecolution.de

          ### üê≥ Docker Images
          - Backend: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${TAG}\`
          - Frontend: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${TAG}\`
          - Migrations: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/migrations-postgres:${TAG}\`

          ### üîÑ ArgoCD
          ArgoCD is configured to track the \`${PR_BRANCH}\` branch for stage deployments.
          The stage environment will sync automatically.

          **After merging this PR**, the stage kustomize updates will be included in \`main\`.

          ---
          *Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"

  log-build-info:
    runs-on: ubuntu-latest
    needs:
      [
        check-release-pr,
        determine-environment,
        build-migrations,
        build-backend,
        build-frontend,
        update-kustomize,
      ]
    if: needs.check-release-pr.outputs.should-build == 'true' && always()
    steps:
      - name: Log build information
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          TAG="${{ needs.determine-environment.outputs.image-tag }}"
          IS_RELEASE="${{ needs.determine-environment.outputs.is-release }}"

          BRANCH="${{ needs.update-kustomize.outputs.target-branch }}"
          if [[ "$IS_RELEASE" == "true" ]]; then
            echo "## üåø Production Release Build Complete" >> $GITHUB_STEP_SUMMARY
          else
            echo "## üß™ Stage Build Complete" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${ENV}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** ${BRANCH}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üê≥ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "* Backend: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "* Frontend: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "* Migrations: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/migrations-postgres:${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Kustomize" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Updated \`deploy/kustomize/${ENV}/kustomization.yaml\` on branch \`${BRANCH}\`" >> $GITHUB_STEP_SUMMARY
