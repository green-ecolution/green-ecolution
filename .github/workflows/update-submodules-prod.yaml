name: "Update submodules Production"

on:
  repository_dispatch:
    types: [update-submodules-production]
  workflow_dispatch:

jobs:
  build-and-push-migrations:
    runs-on: ubuntu-latest
    if : github.event.client_payload.from == 'backend'
    permissions:
      contents: write
      packages: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GREEN_ECOLUTION_PAT }}
          submodules: "true"

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push postgres migrations
        uses: docker/build-push-action@v6
        with:
          context: .
          token: ${{ secrets.GREEN_ECOLUTION_PAT }}
          file: ./.docker/migrations/Dockerfile.postgres
          platforms: linux/amd64
          push: true
          tags: ghcr.io/green-ecolution/migrations-postgres:${{ github.event.client_payload.version }}

  update-submodules-prod:
    needs: build-and-push-migrations
    if: always() && needs.build-and-push-migrations.result != 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Get Green Ecolution App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          permission-contents: write

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          submodules: "recursive"

      - name: Setup kube tools
        uses: yokawasa/action-setup-kube-tools@v0.11.3
        with:
          setup-tools: |
            kustomize
          kustomize: "5.4.3"

      - name: Get Green Ecolution App User ID
        id: get-user-id
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

      - name: Initialize mandatory git config
        run: |
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Update submodules
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: git submodule update  --init --recursive --remote -f

      - name: Bump frontend prod image tag
        if : github.event.client_payload.from == 'frontend'
        run: |
          cd ./deploy/kustomize/prod
          kustomize edit set image frontend-image=ghcr.io/green-ecolution/frontend:${{ github.event.client_payload.version }}

      - name: Bump backend prod image tag
        if : github.event.client_payload.from == 'backend'
        run: |
          cd ./deploy/kustomize/prod
          kustomize edit set image backend-image=ghcr.io/green-ecolution/backend:${{ github.event.client_payload.version }}

      - name: Bump prod init migrations image tag
        if : github.event.client_payload.from == 'backend'
        run: |
          cd ./deploy/kustomize/prod
          kustomize edit set image init-migrations-image=ghcr.io/green-ecolution/migrations-postgres:${{ github.event.client_payload.version }}

      - name: Bump frontend demo image tag
        if : github.event.client_payload.from == 'frontend'
        run: |
          cd ./deploy/kustomize/demo
          kustomize edit set image frontend-image=ghcr.io/green-ecolution/frontend:${{ github.event.client_payload.version }}

      - name: Bump backend demo image tag
        if : github.event.client_payload.from == 'backend'
        run: |
          cd ./deploy/kustomize/demo
          kustomize edit set image backend-image=ghcr.io/green-ecolution/backend:${{ github.event.client_payload.version }}

      - name: Bump demo init migrations image tag
        if : github.event.client_payload.from == 'backend'
        run: |
          cd ./deploy/kustomize/demo
          kustomize edit set image init-migrations-image=ghcr.io/green-ecolution/migrations-postgres:${{ github.event.client_payload.version }}

      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          git add frontend backend deploy/kustomize/prod/kustomization.yaml deploy/kustomize/demo/kustomization.yaml
          git commit -m "chore: update submodules and dump prod image tag to version ${{ github.event.client_payload.version }} [skip ci]" && git push origin develop || echo "No changes to commit"

      - name: Create Release
        if : github.event.client_payload.from == 'frontend'
        uses: thomaseizinger/create-release@2.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GREEN_ECOLUTION_PAT }} 
          BACKEND_REPO: https://github.com/green-ecolution/backend
          FRONTEND_REPO: https://github.com/green-ecolution/frontend
        with:
          target_commitish: ${{ github.event.pull_request.merge_commit_sha }}
          tag_name: ${{ github.event.client_payload.version }}
          name: ${{ github.event.client_payload.version }}
          draft: false
          prerelease: false
          body: |
            ## üåø Green Ecolution Release ${{ github.event.client_payload.version }}

            This release of the Green Ecolution platform marks a new version of our complete smart irrigation system ‚Äî including both the backend and frontend components.

            This repository serves as the central entry point for the project, managing Kubernetes deployments and versioned submodules.

            ### üì¶ What's Included

            * üîó Updated submodules for [backend](${{ env.BACKEND_REPO }}) and [frontend](${{ env.FRONTEND_REPO }})
            * üöÄ Coordinated release of all major platform components
            * üõ†Ô∏è Infrastructure and deployment manifests via Kubernetes
            * üìö Updated documentation for local development and deployment

            For full details, refer to the individual release notes of the respective submodules:

            * [Backend Release Notes](${{ env.BACKEND_REPO }}/releases)
            * [Frontend Release Notes](${{ env.FRONTEND_REPO }}/releases)

