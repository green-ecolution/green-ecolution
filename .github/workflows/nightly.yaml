name: "Nightly Builds"

on:
  workflow_dispatch:
  schedule:
    # Daily at 01:30 UTC
    - cron: '30 1 * * *'
    # Weekly on Sunday at 02:00 UTC (force build for dependency checks)
    - cron: '0 2 * * 0'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: green-ecolution

jobs:
  check-changes:
    name: Check for changes
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      tag: ${{ steps.tag.outputs.tag }}
      is-weekly: ${{ steps.check.outputs.is-weekly }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Check if weekly forced build
        id: weekly-check
        run: |
          # Check if this is the Sunday cron job or workflow_dispatch
          if [[ "${{ github.event.schedule }}" == "0 2 * * 0" ]]; then
            echo "is-weekly=true" >> $GITHUB_OUTPUT
            echo "ðŸ—“ï¸ Weekly forced build triggered"
          else
            echo "is-weekly=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for changes since last nightly
        id: check
        run: |
          IS_WEEKLY="${{ steps.weekly-check.outputs.is-weekly }}"

          # Get last nightly tag
          LAST_NIGHTLY=$(git tag -l --sort=-v:refname "*-nightly.*" | head -n 1)

          if [ -z "$LAST_NIGHTLY" ]; then
            echo "No previous nightly build found, building..."
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "is-weekly=$IS_WEEKLY" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if there are commits since last nightly
          COMMITS_SINCE=$(git rev-list ${LAST_NIGHTLY}..HEAD --count)

          echo "Last nightly: $LAST_NIGHTLY"
          echo "Commits since: $COMMITS_SINCE"

          if [ "$COMMITS_SINCE" -gt 0 ] || [ "$IS_WEEKLY" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "$IS_WEEKLY" == "true" ]; then
              echo "ðŸ—“ï¸ Weekly forced build (dependency check)"
            elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              echo "ðŸ‘¤ Manual trigger"
            else
              echo "âœ… Found $COMMITS_SINCE new commits, building nightly..."
            fi
            echo "should-build=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No changes since last nightly, skipping build"
            echo "should-build=false" >> $GITHUB_OUTPUT
          fi

          echo "is-weekly=$IS_WEEKLY" >> $GITHUB_OUTPUT

      - name: Define tag
        id: tag
        if: steps.check.outputs.should-build == 'true'
        run: |
          DESCRIBE=$(git tag -l --sort=-v:refname | grep -v nightly | head -n 1)
          MAJOR_VERSION=$(echo $DESCRIBE | awk '{split($0,a,"."); print a[1]}')
          MINOR_VERSION=$(echo $DESCRIBE | awk '{split($0,a,"."); print a[2]}')
          MINOR_VERSION="$((${MINOR_VERSION} + 1))"
          TAG="${MAJOR_VERSION}.${MINOR_VERSION}.0-nightly.$(date +'%Y%m%d')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Generated nightly tag: $TAG"

  build-nightly-images:
    name: Build nightly Docker images
    needs: check-changes
    if: needs.check-changes.outputs.should-build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        component: [backend, frontend, migrations]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend
        if: matrix.component == 'backend'
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ needs.check-changes.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:nightly
          build-args: |
            ENV=stage
            APP_VERSION=${{ needs.check-changes.outputs.tag }}
            APP_GIT_COMMIT=${{ github.sha }}
            APP_GIT_BRANCH=develop
            APP_GIT_REPOSITORY=${{ github.repository }}
            APP_BUILD_TIME=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend
        if: matrix.component == 'frontend'
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ needs.check-changes.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:nightly
          build-args: |
            ENV=dev
            BASEURL=/api
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push migrations
        if: matrix.component == 'migrations'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./.docker/migrations/Dockerfile.postgres
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/migrations-postgres:${{ needs.check-changes.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/migrations-postgres:nightly
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-nix-artifacts:
    name: Build Nix artifacts
    needs: check-changes
    if: needs.check-changes.outputs.should-build == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [backend, frontend, default]
        include:
          - target: backend
            output: backend
          - target: frontend
            output: frontend
          - target: default
            output: green-ecolution
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - uses: cachix/cachix-action@v16
        with:
          name: green-ecolution
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Build ${{ matrix.target }}
        run: |
          if [ "${{ matrix.target }}" = "default" ]; then
            nix build
          else
            nix build .#${{ matrix.target }}
          fi

      - name: Package artifacts
        id: package
        run: |
          TAG="${{ needs.check-changes.outputs.tag }}"

          if [ "${{ matrix.target }}" = "frontend" ]; then
            tar -czvf "${{ matrix.output }}_${TAG}.tar.gz" -C result .
            echo "artifact=${{ matrix.output }}_${TAG}.tar.gz" >> $GITHUB_OUTPUT
          else
            cp result/bin/backend "${{ matrix.output }}_linux_amd64-${TAG}"
            echo "artifact=${{ matrix.output }}_linux_amd64-${TAG}" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}-nightly
          path: ${{ steps.package.outputs.artifact }}
          retention-days: 7

  create-release:
    name: Create nightly release
    needs: [check-changes, build-nightly-images, build-nix-artifacts]
    if: needs.check-changes.outputs.should-build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.check-changes.outputs.tag }}
          IS_WEEKLY: ${{ needs.check-changes.outputs.is-weekly }}
        run: |
          RELEASE_NOTES="## ðŸŒ™ Nightly Build ${TAG}

          This is an automated nightly build of the Green Ecolution platform.

          "

          if [ "$IS_WEEKLY" == "true" ]; then
            RELEASE_NOTES+="**ðŸ—“ï¸ Weekly Build** - Built for dependency verification

          "
          fi

          RELEASE_NOTES+="### ðŸ“¦ What's Included

          * ðŸš€ Backend and Frontend components
          * ðŸ—„ï¸ Database migrations
          * ðŸ³ Docker images available in GitHub Container Registry

          ### ðŸ³ Docker Images

          * Backend: \`${REGISTRY}/${IMAGE_PREFIX}/backend:${TAG}\`
          * Frontend: \`${REGISTRY}/${IMAGE_PREFIX}/frontend:${TAG}\`
          * Migrations: \`${REGISTRY}/${IMAGE_PREFIX}/migrations-postgres:${TAG}\`

          ### âš ï¸ Warning

          This is a nightly build and may be unstable. Use at your own risk!
          "

          echo "$RELEASE_NOTES" > release_notes.md

          # Create release with all artifacts
          gh release create ${TAG} \
            --title "Nightly Build ${TAG}" \
            --notes-file release_notes.md \
            --prerelease \
            --latest=false \
            ./artifacts/**/*

  cleanup-old-releases:
    name: Cleanup old nightly releases
    needs: create-release
    if: needs.check-changes.outputs.should-build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Clean up old nightly releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 5
          delete_tags: true
          delete_tag_pattern: nightly
          delete_prerelease_only: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
